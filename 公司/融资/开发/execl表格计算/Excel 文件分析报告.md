# 项目财务测算 Excel 生成系统 - 技术设计文档

## 一、系统概述

### 1.1 业务背景

用户在系统中填写项目财务测算数据（投资、收入、成本等），系统根据这些数据生成包含复杂公式和图表的 Excel 文件供用户下载。

### 1.2 技术选型

| **层级**  | **技术**           | **职责**                     |
| --------- | ------------------ | ---------------------------- |
| 前端      | Vue                | 数据录入界面、文件下载       |
| 后端      | Java (Spring Boot) | 业务逻辑、数据校验、流程控制 |
| Excel处理 | Python (openpyxl)  | 模板填充、公式写入、文件生成 |

### 1.3 选择 Python 处理 Excel 的原因

- 公式写法与 Excel 原生一致，无需转义
- 中文工作表名支持良好
- 跨表公式引用更直观
- 代码简洁，易于维护

------

## 二、系统架构

```plain
┌─────────────────────────────────────────────────────────────────────┐
│                            前端 (Vue)                                │
│                                                                      │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────────────┐   │
│  │  数据录入表单  │ -> │  数据校验     │ -> │  提交请求 & 下载文件  │   │
│  └──────────────┘    └──────────────┘    └──────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼ HTTP POST (JSON)
┌─────────────────────────────────────────────────────────────────────┐
│                        Java 后端 (Spring Boot)                       │
│                                                                      │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────────────┐  │
│  │ 接收请求  │ -> │ 数据校验  │ -> │ 调用Python │ -> │ 返回文件流给前端 │  │
│  └──────────┘   └──────────┘   └──────────┘   └──────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼ 命令行调用 (JSON文件)
┌─────────────────────────────────────────────────────────────────────┐
│                        Python 脚本                                   │
│                                                                      │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────────────┐  │
│  │ 读取JSON  │ -> │ 加载模板  │ -> │ 填充数据  │ -> │ 写入公式 & 保存  │  │
│  └──────────┘   └──────────┘   └──────────┘   └──────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

------

## 三、各层职责详解

### 3.1 前端 (Vue)

#### 职责范围

| **职责**     | **说明**                              |
| ------------ | ------------------------------------- |
| 数据录入界面 | 提供表单让用户输入项目财务数据        |
| 前端校验     | 必填项检查、数值范围校验、格式校验    |
| 请求发送     | 将数据以 JSON 格式提交给后端          |
| 文件下载     | 接收后端返回的文件流，触发浏览器下载  |
| 加载状态     | 显示生成进度（因 Excel 生成需要几秒） |

#### 需要收集的数据

```plain
1. 项目基本信息
   - 项目名称
   - 建设期（年）
   - 运营期（年）

2. 投资数据
   - 建设投资明细
   - 设备投资明细
   - 其他投资

3. 融资数据
   - 资本金金额/比例
   - 贷款金额
   - 贷款利率
   - 还款方式

4. 收入预测（按年）
   - 各类收入来源及金额

5. 成本费用（按年）
   - 固定成本
   - 可变成本
   - 各项费用明细
```

#### 交互流程

```plain
1. 用户填写表单数据
2. 点击"生成Excel"按钮
3. 前端校验数据
4. 显示"生成中..."加载状态
5. 发送 POST 请求到后端
6. 接收文件流
7. 触发浏览器下载
8. 关闭加载状态
```

------

### 3.2 Java 后端 (Spring Boot)

#### 职责范围

| **职责** | **说明**                                     |
| -------- | -------------------------------------------- |
| 接口定义 | 提供 RESTful API 接收前端请求                |
| 数据校验 | 业务规则校验（如：资本金比例不低于20%）      |
| 数据转换 | 将前端数据转换为 Python 脚本需要的 JSON 格式 |
| 进程调用 | 调用 Python 脚本执行 Excel 生成              |
| 超时控制 | 设置脚本执行超时时间，防止进程挂起           |
| 文件处理 | 读取生成的 Excel 文件，返回给前端            |
| 资源清理 | 删除临时文件，防止磁盘占用                   |
| 异常处理 | 捕获并处理各类异常，返回友好错误信息         |
| 日志记录 | 记录关键操作日志，便于问题排查               |

#### 处理流程

```plain
1. 接收前端 POST 请求（JSON 数据）

2. 数据校验
   - 必填字段检查
   - 数值合理性检查
   - 业务规则检查

3. 准备 Python 调用
   - 生成唯一文件名（UUID）
   - 将数据写入临时 JSON 文件
   - 确定输出文件路径

4. 调用 Python 脚本
   - 构建命令行参数
   - 启动子进程
   - 等待执行完成（带超时）
   - 捕获标准输出和错误输出

5. 处理执行结果
   - 成功：读取生成的 Excel 文件
   - 失败：解析错误信息，抛出异常

6. 返回文件
   - 设置响应头（Content-Type, Content-Disposition）
   - 返回文件字节流

7. 清理资源
   - 删除临时 JSON 文件
   - 删除生成的 Excel 文件（已读取到内存）
```

#### 配置项

```plain
- Python 解释器路径
- Python 脚本路径
- Excel 模板文件路径
- 临时文件输出目录
- 脚本执行超时时间（秒）
```

------

### 3.3 Python 脚本

#### 职责范围

| **职责** | **说明**                                       |
| -------- | ---------------------------------------------- |
| 参数解析 | 解析命令行参数（输入JSON、输出路径、模板路径） |
| 数据读取 | 读取并解析 JSON 数据文件                       |
| 模板加载 | 加载 Excel 模板文件                            |
| 数据填充 | 将用户数据填充到模板的固定单元格               |
| 公式写入 | 动态写入计算公式                               |
| 文件保存 | 保存生成的 Excel 文件                          |
| 结果输出 | 输出执行结果（JSON 格式），供 Java 解析        |

#### 处理流程

```plain
1. 解析命令行参数
   --input   : 输入 JSON 文件路径
   --output  : 输出 Excel 文件路径
   --template: 模板文件路径

2. 读取输入数据
   - 读取 JSON 文件
   - 解析为 Python 字典

3. 加载 Excel 模板
   - 使用 openpyxl 加载 .xlsx 文件
   - 保留模板中的图表、样式、格式

4. 填充各工作表数据
   ┌─────────────────────────────────────┐
   │ 工作表                │ 填充内容     │
   ├─────────────────────────────────────┤
   │ 总投资估算            │ 投资明细数据  │
   │ 建设期利息            │ 贷款、利息数据│
   │ 资金筹措              │ 资本金、贷款  │
   │ 项目收入              │ 各年收入数据  │
   │ 总成本费用            │ 各年成本数据  │
   │ 利润与利润分配表       │ 基础参数     │
   └─────────────────────────────────────┘

5. 写入动态公式
   ┌─────────────────────────────────────┐
   │ 工作表                │ 公式类型     │
   ├─────────────────────────────────────┤
   │ 敏感性分析            │ 敏感系数公式  │
   │                       │ IRR/NPV引用  │
   │                       │ 图表数据公式  │
   ├─────────────────────────────────────┤
   │ 盈亏平衡分析表         │ 毛利率公式   │
   │                       │ 盈亏点公式   │
   │                       │ 利用率公式   │
   ├─────────────────────────────────────┤
   │ 财务数据指标           │ 汇总指标公式  │
   │                       │ 比率计算公式  │
   ├─────────────────────────────────────┤
   │ 项目投资现金流量表     │ 现金流公式   │
   │                       │ IRR/NPV公式  │
   └─────────────────────────────────────┘

6. 保存文件
   - 保存到指定输出路径
   - 图表自动更新（引用的数据区域已填充）

7. 输出结果
   - 成功：{"success": true, "output": "文件路径"}
   - 失败：{"success": false, "error": "错误信息"}
```

#### 公式写入详解

**敏感性分析表公式示例：**

```plain
基准值引用：
- D6 = 项目投资现金流量表!J25    (基准IRR)
- E6 = 项目投资现金流量表!J24    (基准NPV)

敏感系数计算：
- G3 = (D3-$D$6)/$D$6/C3         (收入变化对IRR的敏感系数)
- H3 = (E3-$E$6)/$E$6/C3         (收入变化对NPV的敏感系数)

图表数据区域：
- C33:I33 = 收入变化后的NPV系列
- C34:I34 = 建设投资变化后的NPV系列
- C35:I35 = 经营成本变化后的NPV系列
```

**盈亏平衡分析表公式示例：**

```plain
销售毛利率：
- D7 = (利润与利润分配表!G3 - D6) / 利润与利润分配表!G3

盈亏平衡点：
- D9 = D5 / D7    (固定成本 / 销售毛利率)

生产利用率：
- D8 = D5 / (项目收入!D92 - D6 - 项目收入!D107)
```

------

## 四、数据流转

### 4.1 数据格式定义

**前端 -> Java (HTTP JSON)**

```plain
{
  "projectName": "岳池县土地质量提升项目",
  "constructionYears": 2,
  "operationYears": 17,

  "investment": {
    "totalInvestment": 32858.45,
    "constructionCost": 31000.00,
    "equipmentCost": 1500.00
  },

  "funding": {
    "capitalAmount": 6858.45,
    "capitalRatio": 0.2087,
    "loanAmount": 26000.00,
    "interestRate": 0.047
  },

  "income": {
    "yearlyData": [
      {"year": 3, "salesRevenue": 1500.00, "vat": 50.00},
      {"year": 4, "salesRevenue": 1500.00, "vat": 50.00}
    ]
  },

  "cost": {
    "yearlyData": [
      {"year": 3, "fixedCost": 300.00, "variableCost": 200.00},
      {"year": 4, "fixedCost": 300.00, "variableCost": 200.00}
    ]
  }
}
```

**Java -> Python (JSON 文件)**

与上述格式相同，Java 将接收到的数据写入临时 JSON 文件。

**Python -> Java (标准输出)**

```plain
// 成功
{"success": true, "output": "/tmp/excel/uuid_output.xlsx"}

// 失败
{"success": false, "error": "模板文件不存在"}
```

------

## 五、文件说明

### 5.1 Excel 模板文件

模板文件是基于现有的完整 Excel 文件制作，包含：

| **内容**   | **说明**                             |
| ---------- | ------------------------------------ |
| 36个工作表 | 保留全部工作表结构                   |
| 图表       | 保留敏感性分析图、盈亏平衡图、饼图等 |
| 样式格式   | 保留单元格格式、字体、边框、颜色     |
| 固定公式   | 部分不变的公式保留在模板中           |
| 占位单元格 | 需要填充数据的单元格留空或填入占位符 |

### 5.2 图表处理说明

模板中的图表已配置好数据源区域，例如：

```plain
敏感性分析折线图：
- 数据源: 敏感性分析!$C$27:$I$35
- X轴: 变化率 (-15% ~ +15%)
- Y轴: NPV值

资金构成饼图：
- 数据源: 资金筹措!$B$9:$C$10
- 标签: 贷款、资本金
- 数值: 对应金额

盈亏平衡图：
- 数据源: 盈亏平衡分析表!$A$15:$G$18
- 系列: 销售收入、总成本、固定成本、盈亏点
```

**关键点**：只要数据填充到这些区域，图表会自动更新，无需代码操作图表。

------

## 六、执行流程时序图

```plain
前端                Java后端              Python脚本              文件系统
 │                    │                      │                      │
 │  1.提交数据(JSON)   │                      │                      │
 │ ─────────────────> │                      │                      │
 │                    │                      │                      │
 │                    │  2.校验数据           │                      │
 │                    │ ────────┐            │                      │
 │                    │ <───────┘            │                      │
 │                    │                      │                      │
 │                    │  3.写入临时JSON文件    │                      │
 │                    │ ─────────────────────────────────────────> │
 │                    │                      │                      │
 │                    │  4.调用Python脚本     │                      │
 │                    │ ───────────────────> │                      │
 │                    │                      │                      │
 │                    │                      │  5.读取JSON          │
 │                    │                      │ <──────────────────  │
 │                    │                      │                      │
 │                    │                      │  6.加载Excel模板      │
 │                    │                      │ <──────────────────  │
 │                    │                      │                      │
 │                    │                      │  7.填充数据+写入公式  │
 │                    │                      │ ────────┐            │
 │                    │                      │ <───────┘            │
 │                    │                      │                      │
 │                    │                      │  8.保存Excel文件      │
 │                    │                      │ ─────────────────>   │
 │                    │                      │                      │
 │                    │  9.返回执行结果       │                      │
 │                    │ <─────────────────── │                      │
 │                    │                      │                      │
 │                    │  10.读取Excel文件     │                      │
 │                    │ <─────────────────────────────────────────  │
 │                    │                      │                      │
 │                    │  11.删除临时文件      │                      │
 │                    │ ─────────────────────────────────────────> │
 │                    │                      │                      │
 │  12.返回文件流      │                      │                      │
 │ <───────────────── │                      │                      │
 │                    │                      │                      │
 │  13.触发下载        │                      │                      │
 │ ────────┐          │                      │                      │
 │ <───────┘          │                      │                      │
```

------

## 七、异常处理

### 7.1 各层异常处理职责

| **层级** | **异常类型**   | **处理方式**            |
| -------- | -------------- | ----------------------- |
| 前端     | 网络错误       | 提示用户重试            |
| 前端     | 下载失败       | 提示错误信息            |
| Java     | 数据校验失败   | 返回 400 + 具体错误字段 |
| Java     | Python执行超时 | 返回 500 + 超时提示     |
| Java     | Python执行失败 | 返回 500 + 错误详情     |
| Java     | 文件读取失败   | 返回 500 + 文件错误     |
| Python   | 模板不存在     | 输出错误JSON，退出码非0 |
| Python   | JSON解析失败   | 输出错误JSON，退出码非0 |
| Python   | Excel写入失败  | 输出错误JSON，退出码非0 |

### 7.2 错误码定义

| **错误码** | **说明**           |
| ---------- | ------------------ |
| 400001     | 必填字段缺失       |
| 400002     | 数值超出合理范围   |
| 400003     | 业务规则校验失败   |
| 500001     | Python脚本执行超时 |
| 500002     | Python脚本执行错误 |
| 500003     | 文件生成失败       |
| 500004     | 文件读取失败       |

------

## 八、部署要求

### 8.1 服务器环境

| **组件** | **版本要求** | **说明**            |
| -------- | ------------ | ------------------- |
| JDK      | 8+           | 运行 Java 后端      |
| Python   | 3.8+         | 运行 Excel 生成脚本 |
| openpyxl | 3.0+         | Python Excel 处理库 |
| 磁盘空间 | 预留 1GB+    | 临时文件存储        |

### 8.2 文件部署位置

```plain
/opt/app/
├── bank-server.jar              # Java 应用
├── scripts/
│   └── excel_generator.py       # Python 脚本
├── templates/
│   └── 财务测算模板.xlsx          # Excel 模板
└── temp/
    └── excel/                   # 临时文件目录
```

### 8.3 配置项清单

| **配置项**            | **示例值**                           | **说明**          |
| --------------------- | ------------------------------------ | ----------------- |
| python.executable     | /usr/bin/python3                     | Python 解释器路径 |
| excel.script.path     | /opt/app/scripts/excel_generator.py  | 脚本路径          |
| excel.template.path   | /opt/app/templates/财务测算模板.xlsx | 模板路径          |
| excel.temp.dir        | /opt/app/temp/excel                  | 临时目录          |
| excel.timeout.seconds | 120                                  | 执行超时时间      |

------

## 九、性能预估

| **指标**     | **预估值** | **说明**                 |
| ------------ | ---------- | ------------------------ |
| 单次生成耗时 | 3-8 秒     | 取决于数据量和服务器性能 |
| 文件大小     | 5-10 MB    | 与模板大小相近           |
| 内存占用     | ~200 MB    | Python 进程峰值内存      |
| 并发能力     | 10-20 QPS  | 受限于服务器资源         |

------

## 十、后续扩展

| **扩展方向** | **说明**                                 |
| ------------ | ---------------------------------------- |
| 异步生成     | 大文件可改为异步生成，完成后通知用户下载 |
| 任务队列     | 高并发场景可引入消息队列控制并发数       |
| 缓存模板     | Python 进程常驻，避免每次加载模板        |
| 多模板支持   | 支持不同项目类型使用不同模板             |
| 在线预览     | 生成后可在线预览，确认后再下载           |

------

## 附录A：源 Excel 文件分析

### 工作表清单（共36个）

| **序号** | **工作表名称**           | **数据范围** | **说明**          |
| -------- | ------------------------ | ------------ | ----------------- |
| 1        | 投资明细表               | A1:F59       | 投资明细          |
| 2        | 建筑工程明细表           | A1:F175      | 建筑工程          |
| 3        | 机电设备及安装工程       | A1:H130      | 设备安装          |
| 4        | 金属结构设备             | A1:H21       | 金属结构          |
| 5        | 临时工程                 | A1:F87       | 临时工程          |
| 6        | 独立费用                 | A1:F25       | 独立费用          |
| 7        | 经济技术指标表           | A1:J42       | 技术指标          |
| 8        | 总投资估算               | A1:U239      | **核心表**        |
| 9        | 二类费                   | A1:R162      | 二类费用          |
| 10       | 建设期利息               | A1:E11       | **核心表**        |
| 11       | 资金筹措                 | A1:F18       | **核心表**        |
| 12       | 还本付息表               | A1:W85       | 还款计划          |
| 13       | 弃土场收益               | A1:S95       | 收益明细          |
| 14       | 种植类型                 | A1:Q73       | 种植数据          |
| 15       | 项目收入                 | A1:XFD172    | **核心表**        |
| 16       | 生源预测                 | A1:G37       | 预测数据          |
| 17       | 固定资产折旧             | A1:X19       | 折旧计算          |
| 18       | 种植成本                 | A1:M167      | 成本明细          |
| 19       | 参考依据                 | A1:Q252      | 参考资料          |
| 20       | 总成本费用               | A1:V100      | **核心表**        |
| 21       | 成本分项表               | A1:AB59      | 成本分项          |
| 22       | 工资及福利费估算表       | A1:W50       | 人工成本          |
| 23       | 成本分项                 | A1:V28       | 成本分项          |
| 24       | 利润与利润分配表         | A1:Y31       | **核心表**        |
| 25       | 项目投资现金流量表       | A1:X74       | **核心表**        |
| 26       | 项目投资现金流量表(计算) | A1:Q229      | 动态回收期        |
| 27       | 资本金现金流量表         | A1:S28       | 资本金流量        |
| 28       | 财务计划现金流量表       | A1:X29       | 财务计划          |
| 29       | 项目资本金现金流量表     | A1:P21       | 资本金流量        |
| 30       | 盈亏平衡分析表           | A1:Q22       | **核心表-含图表** |
| 31       | 敏感性分析               | A1:J41       | **核心表-含图表** |
| 32       | 敏感性分析表(2)          | A1:H25       | 敏感性补充        |
| 33       | 财务数据指标             | A1:E20       | **核心表**        |
| 34-36    | Sheet1/2/5               | -            | 空白表            |

### 核心图表说明

| **图表**     | **所在工作表** | **数据区域** | **类型** |
| ------------ | -------------- | ------------ | -------- |
| 敏感性分析图 | 敏感性分析     | C27:I35      | 折线图   |
| 盈亏平衡图   | 盈亏平衡分析表 | A15:G18      | 组合图   |
| 资金构成图   | 资金筹措       | B9:C10       | 饼图     |





**ZIP 方式是最佳方案。**

 

这个方案的优势：

1. **完美兼容现有流程** - Java → JSON → Python 不变
2. **绕过 openpyxl 限制** - 加载前移除图表，openpyxl 正常工作
3. **图表完整保留** - ZIP 层面操作，图表数据零损失
4. **跨平台** - 纯 Python 实现，Linux 服务器无额外依赖

**实现步骤简述：**

1. 解压 xlsx（本质是 ZIP）
2. 备份 `xl/charts/` 和 `xl/drawings/` 目录
3. 删除这些目录，重新打包成临时 xlsx
4. openpyxl 加载临时文件 → 填充数据 → 保存
5. 把备份的图表目录加回去
6. 输出最终文件

图表会自动根据填充的数据更新显示，因为图表的数据源引用（如 `Sheet1!$A$1:$A$10`）保持不变。







### 方案可靠性排序（服务器友好优先）

| 方案                     | 可靠性 | 说明                                                         |
| ------------------------ | ------ | ------------------------------------------------------------ |
| **纯 XML 修改**          | ⭐⭐⭐⭐⭐  | 只编辑 `<sheetData>` 单元格，不动 `<drawing>` 标签和 `_rels` 文件 |
| **Java Apache POI**      | ⭐⭐⭐⭐   | 使用完整 XSSF（非流式 SXSSF），通常能保留图表                |
| **xlwings/pywin32**      | ⭐⭐⭐    | 需要 Excel/Windows 环境，服务器不适用                        |
| **LibreOffice headless** | ⭐⭐     | 复杂图表支持不稳定                                           |

### 纯 XML 方案处理 sharedStrings

1. 解析 `xl/sharedStrings.xml`，构建 `{字符串: 索引}` 字典
2. 写入新字符串时：

- 已存在：复用索引
- 不存在：追加 `<si><t>值</t></si>` 到末尾，更新 `count`/`uniqueCount`

1. **不要重排或删除现有条目**，保持索引不变
2. 或者使用内联字符串 `t="inlineStr"` 绕过 sharedStrings

### Python 库现状

- **openpyxl** - 会删除图表引用 ❌
- **xlsxwriter/pyexcelerate** - 只能创建新文件，不能编辑 ❌
- **pylightxl/pyxlsb** - 不支持图表 ❌
- **xlwings** - 需要 Excel 环境 ⚠️

**结论：Python 唯一可靠的无头方案是纯 XML 修改**

### 推荐方案

1. **首选：纯 XML 修改 sheetData + sharedStrings**

- 解压 xlsx
- 用 Python `lxml` 或 `xml.etree` 直接编辑 sheet XML 的 `<sheetData>` 部分
- 其他文件全部保持不动
- 重新打包

1. **备选：Java Apache POI**

- 如果能接受 JVM，POI 是最稳定的开源方案