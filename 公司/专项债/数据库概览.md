# 项目管理数据库表结构分析

## 目录

1. [数据库概览](#数据库概览)
2. [核心业务表结构](#核心业务表结构)
   - [项目相关表组](#1-项目相关表组-project-group)
   - [建安相关表组](#2-建安相关表组-construction-group)
   - [收入相关表组](#3-收入相关表组-revenue-group)
   - [可研相关表组](#4-可研相关表组-research-group)
   - [模板相关表组](#5-模板相关表组-template-group)
   - [系统基础表组](#6-系统基础表组-system-group)
   - [关联表](#7-关联表-association-tables)
   - [字典配置表组](#8-字典配置表组-dictionary-group)
   - [定时任务表组](#9-定时任务表组-quartz-job-group)
   - [日志表组](#10-日志表组-log-group)
   - [代码生成表组](#11-代码生成表组-code-generation-group)
3. [表关系总结图](#表关系总结图)
   - [核心ER图](#核心er图-实体关系图)
   - [系统架构层次图](#系统架构层次图)
   - [核心表关联关系图](#核心表关联关系图)
4. [关键业务逻辑](#关键业务逻辑)
   - [项目创建流程](#1-项目创建流程)
   - [模板使用流程](#2-模板使用流程)
   - [用户权限流程](#3-用户权限流程)
   - [项目审批流程](#4-项目审批流程)
5. [索引建议](#索引建议)
6. [数据完整性说明](#数据完整性说明)
7. [字段类型说明](#字段类型说明)
8. [业务特点总结](#业务特点总结)
9. [附录: 补充图表](#附录-补充图表)
   - [Quartz调度器架构图](#quartz调度器架构图)
   - [数据流转图](#数据流转图)
   - [数据字典关系图](#数据字典关系图)
   - [文件管理关系图](#文件管理关系图)
10. [使用说明](#使用说明)

---

## 数据库概览

数据库名称: `project_manage`
MySQL版本: 8.0.27
表总数: 47张

---

## 核心业务表结构

### 1. 项目相关表组 (Project Group)

#### 1.1 project_info (项目信息表) - 核心主表
- **主键**: `id`
- **关联字段**:
  - `dept_id` → sys_dept.dept_id (部门ID)
  - `contract_id` → 关联合同 (业务关联)
- **用户关联**:
  - `create_user_id`, `initial_review_user_id`, `appoint_user_id`, `compile_user_id`, `final_user_id`, `write_user_id` → sys_user.user_id
- **被关联表**:
  - project_detail
  - project_file
  - project_revenue
  - construction_element
  - revenue_element
  - keyan

#### 1.2 project_detail (项目详情表)
- **主键**: `id`
- **外键关联**:
  - `project_id` → project_info.id
  - `investment_field_a`, `investment_field_b` → investment.id (投向领域A/B)
  - `project_city`, `project_location` → sys_area.id (城市和区位)

#### 1.3 project_file (项目文件表)
- **主键**: `id`
- **外键关联**:
  - `project_id` → project_info.id

#### 1.4 project_revenue (项目收入信息表)
- **主键**: `id`
- **外键关联**:
  - `project_id` → project_info.id
  - `template_id` → revenue_template.id (收入模板)

---

### 2. 建安相关表组 (Construction Group)

#### 2.1 construction_element (项目建安要素表)
- **主键**: `id`
- **外键关联**:
  - `project_id` → project_info.id
  - `construction_id` → construction_info.id (建安ID)
  - `template_id` → construction_element_template.id (模板ID)

#### 2.2 construction_info (建安模板表)
- **主键**: `id`
- **关联字段**:
  - `keyan_id` → keyan.id (可研ID)

#### 2.3 construction_element_template (建安要素模板表)
- **主键**: `id`
- **外键关联**:
  - `construction_template_id` → construction_template.id (二级模板ID)
  - `one_template_id` → level_one_template.id (一级模板ID)

#### 2.4 construction_template (建安模板表)
- **主键**: `id`
- **外键关联**:
  - `level_one_id` → level_one_template.id (一级模板ID)

#### 2.5 construction_zuofa (做法表)
- **主键**: `id`
- **外键关联**:
  - `construction_element_id` → construction_element.id (建安模板ID)

#### 2.6 zuofa (做法表 - 模板)
- **主键**: `id`
- **外键关联**:
  - `construction_element_template_id` → construction_element_template.id (建安模板ID)

---

### 3. 收入相关表组 (Revenue Group)

#### 3.1 revenue_element (收入要素表)
- **主键**: `id`
- **外键关联**:
  - `project_id` → project_info.id
  - `revenue_id` → project_revenue.id (收入信息ID)

#### 3.2 revenue_element_template (收入要素模板表)
- **主键**: `id`
- **外键关联**:
  - `revenue_template_id` → revenue_template.id (模板ID)

#### 3.3 revenue_template (收入模板表)
- **主键**: `id`
- **被关联**: project_revenue, revenue_element_template

---

### 4. 可研相关表组 (Research Group)

#### 4.1 keyan (可研表)
- **主键**: `id`
- **外键关联**:
  - `project_id` → project_info.id
  - `write_user_id` → sys_user.user_id (编写人ID)
- **被关联**: construction_info

---

### 5. 模板相关表组 (Template Group)

#### 5.1 level_one_template (一级模板表)
- **主键**: `id`
- **外键关联**:
  - `investment_field_a`, `investment_field_b` → investment.id (投向领域A/B)
- **被关联**: construction_template, construction_element_template

#### 5.2 expenditure_template (支出模板表)
- **主键**: `id`
- **独立表**: 无直接外键关联

#### 5.3 file_template (文件模板表)
- **主键**: `id`
- **独立表**: 无直接外键关联

---

### 6. 系统基础表组 (System Group)

#### 6.1 sys_user (用户信息表)
- **主键**: `user_id`
- **外键关联**:
  - `dept_id` → sys_dept.dept_id
- **被关联**: project_info (多个用户字段), keyan

#### 6.2 sys_dept (部门表)
- **主键**: `dept_id`
- **自关联**: `parent_id` → sys_dept.dept_id (父部门)
- **被关联**: sys_user, project_info

#### 6.3 sys_role (角色信息表)
- **主键**: `role_id`
- **关联表**: sys_role_menu, sys_role_dept, sys_user_role

#### 6.4 sys_menu (菜单权限表)
- **主键**: `menu_id`
- **自关联**: `parent_id` → sys_menu.menu_id (父菜单)
- **关联表**: sys_role_menu

#### 6.5 sys_area (区域表)
- **主键**: `id`
- **自关联**: `parent_id` → sys_area.id (上级区域)
- **被关联**: project_detail (城市和区位)

#### 6.6 investment (投向领域表)
- **主键**: `id`
- **自关联**: `parent_id` → investment.id (父级ID)
- **被关联**: project_detail, level_one_template

---

### 7. 关联表 (Association Tables)

#### 7.1 sys_user_role (用户角色关联表)
- **复合主键**: (`user_id`, `role_id`)
- **外键**: sys_user.user_id, sys_role.role_id

#### 7.2 sys_role_menu (角色菜单关联表)
- **复合主键**: (`role_id`, `menu_id`)
- **外键**: sys_role.role_id, sys_menu.menu_id

#### 7.3 sys_role_dept (角色部门关联表)
- **复合主键**: (`role_id`, `dept_id`)
- **外键**: sys_role.role_id, sys_dept.dept_id

#### 7.4 sys_user_post (用户岗位关联表)
- **复合主键**: (`user_id`, `post_id`)
- **外键**: sys_user.user_id, sys_post.post_id

---

### 8. 字典配置表组 (Dictionary Group)

#### 8.1 sys_dict_type (字典类型表)
- **主键**: `dict_id`
- **唯一键**: `dict_type`
- **被关联**: sys_dict_data

#### 8.2 sys_dict_data (字典数据表)
- **主键**: `dict_code`
- **外键关联**: `dict_type` → sys_dict_type.dict_type

#### 8.3 sys_config (参数配置表)
- **主键**: `config_id`
- **独立表**

#### 8.4 sys_post (岗位信息表)
- **主键**: `post_id`
- **关联表**: sys_user_post

---

### 9. 定时任务表组 (Quartz Job Group)

#### 9.1 sys_job (定时任务调度表)
- **主键**: `job_id`
- **被关联**: sys_job_log

#### 9.2 sys_job_log (定时任务调度日志表)
- **主键**: `job_log_id`
- **独立表**: 无外键,通过job_name关联

#### 9.3 qrtz_* 系列表 (Quartz调度器表)
- **qrtz_job_details**: 任务详细信息
- **qrtz_triggers**: 触发器详细信息
- **qrtz_cron_triggers**: Cron类型触发器
- **qrtz_simple_triggers**: 简单触发器
- **qrtz_simprop_triggers**: 同步机制行锁
- **qrtz_blob_triggers**: Blob类型触发器
- **qrtz_calendars**: 日历信息
- **qrtz_fired_triggers**: 已触发触发器
- **qrtz_paused_trigger_grps**: 暂停的触发器
- **qrtz_scheduler_state**: 调度器状态
- **qrtz_locks**: 悲观锁信息

**外键约束**:
- qrtz_triggers.job_name → qrtz_job_details.job_name
- qrtz_cron_triggers → qrtz_triggers (trigger_name, trigger_group)
- qrtz_simple_triggers → qrtz_triggers (trigger_name, trigger_group)
- qrtz_simprop_triggers → qrtz_triggers (trigger_name, trigger_group)
- qrtz_blob_triggers → qrtz_triggers (trigger_name, trigger_group)

---

### 10. 日志表组 (Log Group)

#### 10.1 sys_logininfor (系统访问记录表)
- **主键**: `info_id`
- **独立表**: 记录登录日志

#### 10.2 sys_oper_log (操作日志记录表)
- **主键**: `oper_id`
- **独立表**: 记录操作日志

#### 10.3 sys_notice (通知公告表)
- **主键**: `notice_id`
- **独立表**

---

### 11. 代码生成表组 (Code Generation Group)

#### 11.1 gen_table (代码生成业务表)
- **主键**: `table_id`
- **被关联**: gen_table_column

#### 11.2 gen_table_column (代码生成业务表字段)
- **主键**: `column_id`
- **外键关联**: `table_id` → gen_table.table_id

---

## 表关系总结图

### 核心ER图 (实体关系图)

```mermaid
erDiagram
    %% 项目核心表
    project_info ||--o{ project_detail : "1对1"
    project_info ||--o{ project_file : "1对多"
    project_info ||--o{ project_revenue : "1对多"
    project_info ||--o{ construction_element : "1对多"
    project_info ||--o{ revenue_element : "1对多"
    project_info ||--o| keyan : "1对1"

    %% 项目收入关系
    project_revenue ||--o{ revenue_element : "1对多"
    revenue_template ||--o{ project_revenue : "模板实例化"
    revenue_template ||--o{ revenue_element_template : "1对多"

    %% 建安要素关系
    construction_element ||--o{ construction_zuofa : "1对多"
    construction_element_template ||--o{ zuofa : "1对多"
    construction_element_template ||--o{ construction_element : "模板实例化"

    %% 模板体系
    level_one_template ||--o{ construction_template : "1对多"
    level_one_template ||--o{ construction_element_template : "1对多"
    construction_template ||--o{ construction_element_template : "1对多"

    %% 建安信息
    construction_info ||--o{ construction_element : "1对多"
    keyan ||--o{ construction_info : "1对多"

    %% 用户部门关系
    sys_dept ||--o{ sys_user : "1对多"
    sys_dept ||--o{ project_info : "1对多"
    sys_user ||--o{ project_info : "创建人/审核人"
    sys_user ||--o{ keyan : "编写人"

    %% 权限关系
    sys_user }o--o{ sys_role : "多对多"
    sys_role }o--o{ sys_menu : "多对多"
    sys_role }o--o{ sys_dept : "多对多"
    sys_user }o--o{ sys_post : "多对多"

    %% 基础数据
    investment ||--o{ project_detail : "投向领域"
    investment ||--o{ level_one_template : "投向领域"
    sys_area ||--o{ project_detail : "城市/区位"

    %% 字典
    sys_dict_type ||--o{ sys_dict_data : "1对多"
```

### 系统架构层次图

```mermaid
graph TB
    subgraph "业务层"
        A[项目管理模块]
        B[模板管理模块]
        C[财务管理模块]
        D[可研管理模块]
    end

    subgraph "权限层"
        E[用户管理]
        F[角色管理]
        G[菜单管理]
        H[部门管理]
    end

    subgraph "数据层"
        I[项目数据]
        J[模板数据]
        K[财务数据]
        L[系统数据]
    end

    subgraph "支撑层"
        M[定时任务]
        N[操作日志]
        O[字典管理]
        P[文件管理]
    end

    A --> I
    B --> J
    C --> K
    D --> I

    E --> L
    F --> L
    G --> L
    H --> L

    A -.权限控制.-> E
    B -.权限控制.-> F
    C -.权限控制.-> G

    I --> M
    J --> N
    K --> O
    L --> P

    style A fill:#e1f5ff
    style B fill:#e1f5ff
    style C fill:#e1f5ff
    style D fill:#e1f5ff
    style E fill:#fff4e1
    style F fill:#fff4e1
    style G fill:#fff4e1
    style H fill:#fff4e1
```

### 核心表关联关系图

```mermaid
graph LR
    subgraph "项目核心"
        PI[project_info<br/>项目信息]
        PD[project_detail<br/>项目详情]
        PF[project_file<br/>项目文件]
        KY[keyan<br/>可研]
    end

    subgraph "收入体系"
        PR[project_revenue<br/>项目收入]
        RE[revenue_element<br/>收入要素]
        RT[revenue_template<br/>收入模板]
        RET[revenue_element_template<br/>收入要素模板]
    end

    subgraph "建安体系"
        CE[construction_element<br/>建安要素]
        CZ[construction_zuofa<br/>做法]
        CI[construction_info<br/>建安信息]
        CET[construction_element_template<br/>建安要素模板]
        ZF[zuofa<br/>做法模板]
    end

    subgraph "模板系统"
        L1[level_one_template<br/>一级模板]
        CT[construction_template<br/>二级模板]
    end

    subgraph "基础数据"
        INV[investment<br/>投向领域]
        AREA[sys_area<br/>区域]
    end

    subgraph "用户权限"
        USER[sys_user<br/>用户]
        DEPT[sys_dept<br/>部门]
    end

    %% 项目关联
    PI --> PD
    PI --> PF
    PI --> PR
    PI --> CE
    PI --> RE
    PI --> KY

    %% 收入关联
    PR --> RE
    RT -.模板.-> PR
    RT --> RET

    %% 建安关联
    CE --> CZ
    CI --> CE
    KY --> CI
    CET -.模板.-> CE
    CET --> ZF

    %% 模板关联
    L1 --> CT
    L1 --> CET
    CT --> CET

    %% 基础数据关联
    INV --> PD
    INV --> L1
    AREA --> PD

    %% 用户关联
    USER --> PI
    USER --> KY
    DEPT --> USER
    DEPT --> PI

    style PI fill:#ff6b6b
    style PD fill:#ff6b6b
    style RT fill:#4ecdc4
    style RET fill:#4ecdc4
    style CET fill:#ffe66d
    style ZF fill:#ffe66d
    style L1 fill:#95e1d3
    style CT fill:#95e1d3
```

---

## 关键业务逻辑

### 1. 项目创建流程

```mermaid
flowchart TD
    Start([开始创建项目]) --> A[创建用户登录]
    A --> B[创建project_info<br/>项目基础信息]
    B --> C{选择投向领域<br/>和区域}
    C --> D[创建project_detail<br/>项目详情]
    D --> E{选择模板}

    E --> F1[选择建安模板]
    E --> F2[选择收入模板]

    F1 --> G1[从construction_element_template<br/>复制到construction_element]
    G1 --> G2[从zuofa复制到<br/>construction_zuofa]

    F2 --> H1[从revenue_template<br/>复制到project_revenue]
    H1 --> H2[从revenue_element_template<br/>复制到revenue_element]

    G2 --> I{需要可研?}
    H2 --> I

    I -->|是| J[创建keyan<br/>可研信息]
    I -->|否| K[上传project_file<br/>项目文件]
    J --> K

    K --> L[初审人审核]
    L --> M{审核通过?}
    M -->|否| N[退回修改]
    N --> D
    M -->|是| O[指定编写人]
    O --> P[编写人编写]
    P --> Q[终审人终审]
    Q --> R{终审通过?}
    R -->|否| S[退回编写]
    S --> P
    R -->|是| End([项目创建完成])

    style Start fill:#90EE90
    style End fill:#FFB6C1
    style B fill:#87CEEB
    style D fill:#87CEEB
    style G1 fill:#FFE4B5
    style H1 fill:#FFE4B5
    style J fill:#DDA0DD
```

**流程说明**:
1. 创建用户在 `project_info` 创建项目基础信息
2. 在 `project_detail` 添加项目详细信息(关联投向领域`investment`、区域`sys_area`)
3. 根据选择的模板在 `construction_element` 创建建安要素
4. 根据模板在 `project_revenue` 创建收入信息
5. 在 `revenue_element` 创建收入要素明细
6. 可选: 创建 `keyan` 可研信息
7. 上传项目文件到 `project_file`
8. 经过多级审批流程(初审→指定→编写→终审)

### 2. 模板使用流程

```mermaid
flowchart LR
    subgraph "模板配置阶段"
        A[创建level_one_template<br/>一级模板] --> B[创建construction_template<br/>二级模板]
        B --> C[创建construction_element_template<br/>建安要素模板]
        C --> D[创建zuofa<br/>做法模板]

        E[创建revenue_template<br/>收入模板] --> F[创建revenue_element_template<br/>收入要素模板]
    end

    subgraph "项目实例化阶段"
        G[选择模板] --> H{模板类型}
        H -->|建安模板| I[复制construction_element_template<br/>→ construction_element]
        H -->|收入模板| J[复制revenue_template<br/>→ project_revenue]

        I --> K[复制zuofa<br/>→ construction_zuofa]
        J --> L[复制revenue_element_template<br/>→ revenue_element]

        K --> M[项目建安要素创建完成]
        L --> N[项目收入信息创建完成]
    end

    C -.提供模板.-> I
    D -.提供模板.-> K
    E -.提供模板.-> J
    F -.提供模板.-> L

    style A fill:#95e1d3
    style B fill:#95e1d3
    style C fill:#ffe66d
    style D fill:#ffe66d
    style E fill:#4ecdc4
    style F fill:#4ecdc4
    style I fill:#ffcccc
    style J fill:#ccddff
    style K fill:#ffcccc
    style L fill:#ccddff
```

**流程说明**:
1. **模板配置**: 先创建模板层级结构
   - 一级模板 → 二级模板 → 建安要素模板 → 做法模板
   - 收入模板 → 收入要素模板
2. **项目实例化**: 从模板复制到项目实例
   - `construction_element_template` → `construction_element`
   - `zuofa` → `construction_zuofa`
   - `revenue_template` → `project_revenue`
   - `revenue_element_template` → `revenue_element`

### 3. 用户权限流程

```mermaid
flowchart TD
    subgraph "用户基础信息"
        A[sys_user<br/>用户] --> B[sys_dept<br/>所属部门]
        A --> C[sys_post<br/>所属岗位]
    end

    subgraph "角色分配"
        A --> D[sys_user_role<br/>用户角色关联]
        D --> E[sys_role<br/>角色]
    end

    subgraph "权限获取"
        E --> F[sys_role_menu<br/>角色菜单关联]
        F --> G[sys_menu<br/>菜单权限]

        E --> H[sys_role_dept<br/>角色部门关联]
        H --> I[数据权限范围]
    end

    subgraph "权限应用"
        G --> J{用户访问功能}
        I --> K{用户访问数据}

        J -->|有权限| L[允许访问菜单]
        J -->|无权限| M[拒绝访问]

        K -->|本部门数据| N[显示本部门数据]
        K -->|本部门及下级| O[显示本部门及下级数据]
        K -->|全部数据| P[显示所有数据]
        K -->|自定义权限| Q[按规则过滤数据]
    end

    subgraph "项目权限"
        A -.创建者.-> R[project_info]
        B -.部门.-> R
        I -.数据权限.-> R
    end

    style A fill:#FFB6C1
    style E fill:#87CEEB
    style G fill:#90EE90
    style I fill:#FFE4B5
    style L fill:#98FB98
    style M fill:#FF6B6B
    style R fill:#DDA0DD
```

**流程说明**:
1. **用户基础**: `sys_user` 属于 `sys_dept` (部门) 和 `sys_post` (岗位)
2. **角色分配**: 通过 `sys_user_role` 关联到 `sys_role`
3. **菜单权限**: 通过 `sys_role_menu` 获取 `sys_menu` 菜单权限
4. **数据权限**: 通过 `sys_role_dept` 设置数据权限范围
   - 全部数据权限(1)
   - 自定义数据权限(2)
   - 本部门数据权限(3)
   - 本部门及以下数据权限(4)
5. **项目访问**: 结合用户、部门、数据权限控制项目访问范围

### 4. 项目审批流程

```mermaid
stateDiagram-v2
    [*] --> 创建: 创建用户创建项目
    创建 --> 初审: create_user提交
    初审 --> 指定: initial_review_user审核通过
    初审 --> 创建: 退回修改
    指定 --> 编写: appoint_user指定编写人
    编写 --> 终审: compile_user编写完成
    编写 --> 指定: 退回重新指定
    终审 --> 完成: final_user审核通过
    终审 --> 编写: 退回修改
    完成 --> [*]

    note right of 创建
        状态: 草稿
        表: project_info
        字段: create_user_id
    end note

    note right of 初审
        状态: 待初审
        字段: initial_review_user_id
        审核意见: review_comments
    end note

    note right of 指定
        状态: 待指定
        字段: appoint_user_id
    end note

    note right of 编写
        状态: 编写中
        字段: compile_user_id
        关联: keyan表
    end note

    note right of 终审
        状态: 待终审
        字段: final_user_id
    end note

    note right of 完成
        状态: 已完成
        文件状态: file_status=1
    end note
```

---

## 索引建议

当前数据库索引情况:
- 所有主键都有索引
- `sys_logininfor`: status, login_time 有索引
- `sys_oper_log`: business_type, status, oper_time 有索引
- `sys_dict_type`: dict_type 有唯一索引

**建议添加的索引**:
1. `project_info.dept_id` - 按部门查询项目
2. `project_info.status` - 按状态筛选项目
3. `project_detail.project_id` - 加速关联查询
4. `construction_element.project_id` - 加速关联查询
5. `project_revenue.project_id` - 加速关联查询
6. `revenue_element.revenue_id` - 加速关联查询
7. `sys_user.dept_id` - 加速用户部门查询

---

## 数据完整性说明

### 已有外键约束
- Quartz 调度器相关表之间有外键约束
- 其他业务表主要通过应用层维护关联关系

### 级联删除风险
由于大部分表没有外键约束,删除操作需要在应用层处理:
1. 删除项目时需要同步删除: project_detail, project_file, project_revenue, construction_element, revenue_element
2. 删除用户时需要检查: project_info 中的各个用户ID字段
3. 删除部门时需要检查: sys_user, project_info

---

## 字段类型说明

### 金额字段
- 主要使用 `decimal(20,2)` - 支持大额金额,精确到分
- 部分使用 `decimal(10,2)` - 中等金额

### 文本字段
- `varchar(255)` - 一般文本
- `varchar(2000)` - 长文本
- `text` - 超长文本内容
- `longblob` - 二进制大对象(如公告内容)

### 状态字段
- 统一使用 `int` 或 `char(1)`
- 0通常表示正常/启用, 1表示停用/失败

---

## 业务特点总结

1. **模板驱动**: 系统采用模板+实例的设计模式,先配置模板,再基于模板创建项目实例
2. **多级审批**: 项目有创建人、初审人、指定人、编写人、终审人等多个角色参与
3. **财务计算**: 涉及大量财务指标计算(资本金、专项债、市场融资等)
4. **文件管理**: 项目关联文件管理功能
5. **权限控制**: 完整的RBAC权限体系(用户-角色-菜单-部门)
6. **数据字典**: 使用字典表统一管理枚举值
7. **审计日志**: 完整的登录日志、操作日志记录

---

## 附录: 补充图表

### Quartz调度器架构图

```mermaid
graph TB
    subgraph "任务定义层"
        A[qrtz_job_details<br/>任务详细信息]
    end

    subgraph "触发器层"
        B[qrtz_triggers<br/>触发器主表]
        C[qrtz_cron_triggers<br/>Cron触发器]
        D[qrtz_simple_triggers<br/>简单触发器]
        E[qrtz_simprop_triggers<br/>属性触发器]
        F[qrtz_blob_triggers<br/>Blob触发器]
    end

    subgraph "辅助信息层"
        G[qrtz_calendars<br/>日历信息]
        H[qrtz_fired_triggers<br/>已触发记录]
        I[qrtz_paused_trigger_grps<br/>暂停的触发器组]
    end

    subgraph "状态管理层"
        J[qrtz_scheduler_state<br/>调度器状态]
        K[qrtz_locks<br/>悲观锁]
    end

    subgraph "应用层"
        L[sys_job<br/>系统任务配置]
        M[sys_job_log<br/>任务执行日志]
    end

    A -->|1:N| B
    B -->|1:1| C
    B -->|1:1| D
    B -->|1:1| E
    B -->|1:1| F

    B -.参考.-> G
    B --> H
    B -.暂停.-> I

    B -.调度.-> J
    B -.锁定.-> K

    L -.配置.-> A
    L --> M

    style A fill:#FFE4B5
    style B fill:#87CEEB
    style C fill:#98FB98
    style D fill:#98FB98
    style E fill:#98FB98
    style F fill:#98FB98
    style L fill:#FFB6C1
    style M fill:#DDA0DD
```

### 数据流转图

```mermaid
graph TB
    subgraph "用户输入"
        U1[用户创建项目]
        U2[选择模板]
        U3[填写财务数据]
        U4[上传文件]
    end

    subgraph "模板数据源"
        T1[level_one_template]
        T2[construction_template]
        T3[revenue_template]
        T4[construction_element_template]
        T5[revenue_element_template]
    end

    subgraph "项目数据"
        P1[project_info]
        P2[project_detail]
        P3[construction_element]
        P4[project_revenue]
        P5[revenue_element]
        P6[project_file]
        P7[keyan]
    end

    subgraph "基础数据"
        B1[investment投向领域]
        B2[sys_area区域]
        B3[sys_dept部门]
        B4[sys_user用户]
    end

    subgraph "计算结果"
        C1[财务报表]
        C2[投资估算]
        C3[收益分析]
        C4[可研报告]
    end

    U1 --> P1
    U2 --> T1
    U2 --> T3
    U3 --> P4
    U4 --> P6

    T1 --> T2
    T2 --> T4
    T3 --> T5

    T4 -.实例化.-> P3
    T5 -.实例化.-> P5

    P1 --> P2
    P1 --> P3
    P1 --> P4
    P1 --> P5
    P1 --> P6
    P1 --> P7

    B1 --> P2
    B2 --> P2
    B3 --> P1
    B4 --> P1

    P1 --> C1
    P3 --> C2
    P4 --> C3
    P7 --> C4

    style U1 fill:#90EE90
    style U2 fill:#90EE90
    style U3 fill:#90EE90
    style U4 fill:#90EE90
    style T1 fill:#FFE4B5
    style T3 fill:#FFE4B5
    style P1 fill:#FF6B6B
    style C1 fill:#87CEEB
    style C2 fill:#87CEEB
    style C3 fill:#87CEEB
    style C4 fill:#87CEEB
```

### 数据字典关系图

```mermaid
graph LR
    A[sys_dict_type<br/>字典类型] -->|1:N| B[sys_dict_data<br/>字典数据]

    subgraph "常用字典类型"
        C[项目类型]
        D[建设类型]
        E[投向领域]
        F[项目状态]
        G[文件类型]
        H[计费周期]
    end

    B -.提供枚举值.-> C
    B -.提供枚举值.-> D
    B -.提供枚举值.-> E
    B -.提供枚举值.-> F
    B -.提供枚举值.-> G
    B -.提供枚举值.-> H

    C -.应用于.-> I[project_info.project_type]
    D -.应用于.-> J[project_detail.construction_type]
    F -.应用于.-> K[project_info.status]
    G -.应用于.-> L[project_file.file_type]
    H -.应用于.-> M[project_revenue.charging_type]

    style A fill:#FFB6C1
    style B fill:#87CEEB
    style I fill:#DDA0DD
    style J fill:#DDA0DD
    style K fill:#DDA0DD
    style L fill:#DDA0DD
    style M fill:#DDA0DD
```

### 文件管理关系图

```mermaid
graph TB
    subgraph "文件模板"
        FT[file_template<br/>文件模板]
        FT1[专项债文件模板]
        FT2[可研文件模板]
    end

    subgraph "项目文件"
        PF[project_file<br/>项目文件]
        PF1[文档类文件]
        PF2[图片类文件]
        PF3[其他附件]
    end

    subgraph "项目关联"
        PI[project_info<br/>项目信息]
        PD[project_detail<br/>项目详情]
        KY[keyan<br/>可研]
    end

    FT --> FT1
    FT --> FT2

    FT1 -.指导.-> PF
    FT2 -.指导.-> PF

    PF --> PF1
    PF --> PF2
    PF --> PF3

    PI -->|1:N| PF
    PD -.关联.-> PF
    KY -.关联.-> PF

    PF1 --> Storage[(文件存储系统)]
    PF2 --> Storage
    PF3 --> Storage

    style FT fill:#FFE4B5
    style PF fill:#87CEEB
    style PI fill:#FF6B6B
    style Storage fill:#98FB98
```

---

## 使用说明

### 如何阅读ER图
- `||--o{` 表示一对多关系
- `||--o|` 表示一对一关系
- `}o--o{` 表示多对多关系
- `-.->` 表示虚线关系(逻辑关联,无强制外键)

### 如何阅读流程图
- 矩形框 `[]` 表示处理步骤
- 菱形框 `{}` 表示判断/决策
- 圆角框 `([])` 表示开始/结束
- 实线箭头 `-->` 表示流程方向
- 虚线箭头 `-.->` 表示参考/引用关系

### 颜色说明
- **红色系** (#FF6B6B, #FFB6C1): 核心业务表(项目相关)
- **蓝色系** (#87CEEB, #4ecdc4): 收入/财务相关
- **黄色系** (#FFE4B5, #ffe66d): 建安/模板相关
- **绿色系** (#90EE90, #95e1d3, #98FB98): 成功/完成状态
- **紫色系** (#DDA0DD): 可研/特殊业务
