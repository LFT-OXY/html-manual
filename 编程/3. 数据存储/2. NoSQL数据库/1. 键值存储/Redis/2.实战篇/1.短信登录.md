# 1.å¯¼å…¥é»‘é©¬ç‚¹è¯„é¡¹ç›®

## 1.1 é¦–å…ˆï¼Œå¯¼å…¥è¯¾å‰èµ„æ–™æä¾›çš„SQLæ–‡ä»¶ï¼š

![CleanShot 2025-10-12 at 14.54.47@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2014.54.47@2x.png)

![CleanShot 2025-10-12 at 14.55.02@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2014.55.02@2x.png)

![CleanShot 2025-10-12 at 14.55.16@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2014.55.16@2x.png)

## 1.2  å¯¼å…¥åç«¯é¡¹ç›®

åœ¨èµ„æ–™ä¸­æä¾›äº†ä¸€ä¸ªé¡¹ç›®æºç ï¼š

![CleanShot 2025-10-12 at 14.56.29@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2014.56.29@2x.png)

å°†å…¶å¤åˆ¶åˆ°ä½ çš„ideaå·¥ä½œç©ºé—´ï¼Œç„¶ååˆ©ç”¨ideaæ‰“å¼€å³å¯ï¼š

![CleanShot 2025-10-12 at 14.56.43@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2014.56.43@2x.png)

å¯åŠ¨é¡¹ç›®åï¼Œåœ¨æµè§ˆå™¨è®¿é—®ï¼š http://localhost:8081/shop-type/list
å¦‚æœå¯ä»¥çœ‹åˆ°æ•°æ®åˆ™è¯æ˜è¿è¡Œæ²¡æœ‰é—®é¢˜

**ä¸è¦å¿˜äº†ä¿®æ”¹application.yamlæ–‡ä»¶ä¸­çš„mysqlã€redisåœ°å€ä¿¡æ¯**

## 1.3 å¯¼å…¥å‰ç«¯é¡¹ç›®

åœ¨èµ„æ–™ä¸­æä¾›äº†ä¸€ä¸ªnginxæ–‡ä»¶å¤¹ï¼š

![CleanShot 2025-10-12 at 15.10.28@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2015.10.28@2x.png)

å°†å…¶å¤åˆ¶åˆ°ä»»æ„ç›®å½•ï¼Œè¦ç¡®ä¿è¯¥ç›®å½•ä¸åŒ…å«ä¸­æ–‡ã€ç‰¹æ®Šå­—ç¬¦å’Œç©ºæ ¼ï¼Œä¾‹å¦‚ï¼š

![CleanShot 2025-10-12 at 15.10.42@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2015.10.42@2x.png)

### è¿è¡Œå‰ç«¯é¡¹ç›®

åœ¨nginxæ‰€åœ¨ç›®å½•ä¸‹æ‰“å¼€ä¸€ä¸ªCMDçª—å£ï¼Œè¾“å…¥å‘½ä»¤ï¼š

```
start nginx. exe
```

æ‰“å¼€chromeæµè§ˆå™¨ï¼Œåœ¨ç©ºç™½é¡µé¢ç‚¹å‡»é¼ æ ‡å³é”®ï¼Œé€‰æ‹©æ£€æŸ¥ï¼Œå³å¯æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼š

![CleanShot 2025-10-12 at 15.23.53@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2015.23.53@2x.png)

ç„¶åæ‰“å¼€æ‰‹æœºæ¨¡å¼ï¼š

![CleanShot 2025-10-12 at 15.24.07@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2015.24.07@2x.png)

ç„¶åè®¿é—®ï¼š http://127.0.0.1:8080
å³å¯çœ‹åˆ°é¡µé¢



**å¦‚æœæ˜¯macOSï¼Œè¿™æ ·å¯åŠ¨:**
### macOS å¯åŠ¨ Nginx å®Œæ•´æŒ‡å—

#### ğŸš¨ é‡è¦æç¤º

**nginx.exe æ˜¯ Windows å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ— æ³•åœ¨ macOS ä¸Šç›´æ¥è¿è¡Œï¼**

æ‚¨éœ€è¦åœ¨ macOS ä¸Šé‡æ–°å®‰è£… Nginxã€‚

---

#### æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ Homebrew å®‰è£…ï¼ˆå¼ºçƒˆæ¨èï¼‰â­

##### Step 1: å®‰è£… Homebrewï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰

```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

##### Step 2: å®‰è£… Nginx

```bash
brew install nginx
```

##### Step 3: å¯åŠ¨ Nginx

```bash
# æ–¹æ³•1: ç›´æ¥å¯åŠ¨
sudo nginx

# æ–¹æ³•2: ä½¿ç”¨ Homebrew æœåŠ¡ï¼ˆæ¨èï¼‰
brew services start nginx

# æŸ¥çœ‹çŠ¶æ€
brew services list
```

##### Step 4: éªŒè¯å®‰è£…

```bash
# æ£€æŸ¥ Nginx ç‰ˆæœ¬
nginx -v

# æµ‹è¯•é…ç½®æ–‡ä»¶
nginx -t

# è®¿é—®æµ‹è¯•
open http://localhost:8080
```

##### å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨
brew services start nginx
# æˆ–
sudo nginx

# åœæ­¢
brew services stop nginx
# æˆ–
sudo nginx -s stop

# é‡å¯
brew services restart nginx
# æˆ–
sudo nginx -s reload

# æŸ¥çœ‹çŠ¶æ€
brew services list
```

---

#### æ–¹æ¡ˆäºŒï¼šè¿ç§»æ‚¨å½“å‰çš„é…ç½®

å¦‚æœæ‚¨æƒ³ä½¿ç”¨å½“å‰ç›®å½•çš„é…ç½®æ–‡ä»¶ï¼š

##### Step 1: å®‰è£… Nginxï¼ˆåŒä¸Šï¼‰

```bash
brew install nginx
```

##### Step 2: å¤åˆ¶é…ç½®æ–‡ä»¶

```bash
# æ‰¾åˆ° Homebrew å®‰è£…çš„ Nginx é…ç½®ç›®å½•
# é€šå¸¸åœ¨ï¼š/opt/homebrew/etc/nginx/ æˆ– /usr/local/etc/nginx/

# å¤åˆ¶æ‚¨çš„é…ç½®
cp ~/ç”¨æˆ·/oxy/æ–‡ç¨¿/program/front/nginx-1.18.0/conf/nginx.conf /opt/homebrew/etc/nginx/nginx.conf

# å¤åˆ¶ html æ–‡ä»¶
cp -r ~/ç”¨æˆ·/oxy/æ–‡ç¨¿/program/front/nginx-1.18.0/html/* /opt/homebrew/var/www/
```

##### Step 3: æµ‹è¯•å¹¶å¯åŠ¨

```bash
# æµ‹è¯•é…ç½®
nginx -t

# å¯åŠ¨
sudo nginx
```

---

#### å¿«é€Ÿå¯åŠ¨æŒ‡å—ï¼ˆæ¨èæ–°æ‰‹ï¼‰

```bash
# 1. å®‰è£… Nginx
brew install nginx

# 2. æŸ¥çœ‹å®‰è£…ä½ç½®
which nginx
# è¾“å‡ºï¼š/opt/homebrew/bin/nginx

# 3. æŸ¥çœ‹é…ç½®æ–‡ä»¶ä½ç½®
nginx -t
# è¾“å‡ºï¼šnginx: configuration file /opt/homebrew/etc/nginx/nginx.conf test is successful

# 4. å¯åŠ¨ Nginx
brew services start nginx

# 5. éªŒè¯è¿è¡Œ
curl http://localhost:8080
# æˆ–åœ¨æµè§ˆå™¨æ‰“å¼€ http://localhost:8080

# 6. æŸ¥çœ‹æ—¥å¿—
tail -f /opt/homebrew/var/log/nginx/access.log
tail -f /opt/homebrew/var/log/nginx/error.log
```

---

#### å¸¸è§é—®é¢˜è§£å†³

##### 1. ç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹å ç”¨ç«¯å£çš„è¿›ç¨‹
sudo lsof -i :8080

# æ€æ­»è¿›ç¨‹
sudo kill -9 <PID>
```

##### 2. æƒé™é—®é¢˜

```bash
# ç¡®ä¿æœ‰æ‰§è¡Œæƒé™
sudo nginx

# æˆ–ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ç”¨æˆ·
# ç¼–è¾‘ /opt/homebrew/etc/nginx/nginx.conf
# å°† user nobody; æ”¹ä¸º user ä½ çš„ç”¨æˆ·å;
```

##### 3. é…ç½®æ–‡ä»¶è·¯å¾„

```bash
# Homebrew å®‰è£…çš„ Nginx é…ç½®æ–‡ä»¶ä½ç½®
# Intel Mac: /usr/local/etc/nginx/
# Apple Silicon (M1/M2): /opt/homebrew/etc/nginx/

# ç½‘ç«™æ ¹ç›®å½•
# Intel Mac: /usr/local/var/www/
# Apple Silicon: /opt/homebrew/var/www/
```

---

#### æˆ‘çš„æ¨èæ–¹æ¡ˆ ğŸ¯

**æˆ‘å»ºè®®ï¼š**

1. **ä½¿ç”¨ Homebrew å®‰è£… Nginx**ï¼ˆæœ€ç®€å•ï¼‰
2. **å°†æ‚¨çš„é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°æ–°çš„ Nginx é…ç½®ç›®å½•**
3. **å°† html æ–‡ä»¶å¤åˆ¶åˆ°æ–°çš„ç½‘ç«™æ ¹ç›®å½•**

å…·ä½“æ“ä½œï¼š

```bash
# 1. å®‰è£…
brew install nginx

# 2. å¤‡ä»½åŸé…ç½®
cp /opt/homebrew/etc/nginx/nginx.conf /opt/homebrew/etc/nginx/nginx.conf.backup

# 3. å¤åˆ¶æ‚¨çš„é…ç½®ï¼ˆéœ€è¦è°ƒæ•´è·¯å¾„ï¼‰
cp ~/ç”¨æˆ·/oxy/æ–‡ç¨¿/program/front/nginx-1.18.0/conf/nginx.conf /opt/homebrew/etc/nginx/

# 4. å¤åˆ¶ç½‘ç«™æ–‡ä»¶
cp -r ~/ç”¨æˆ·/oxy/æ–‡ç¨¿/program/front/nginx-1.18.0/html/* /opt/homebrew/var/www/

# 5. æµ‹è¯•é…ç½®
nginx -t

# 6. å¯åŠ¨
brew services start nginx
```

---



# 2.åŸºäºSessionå®ç°ç™»å½•


![CleanShot 2025-10-12 at 15.37.45@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2015.37.45@2x.png)


## 2.1 å‘é€çŸ­ä¿¡éªŒè¯ç 

![CleanShot 2025-10-12 at 15.40.29@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2015.40.29@2x.png)


```java
package com.hmdp.service.impl;  
  
import cn.hutool.core.util.RandomUtil;  
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;  
import com.hmdp.dto.Result;  
import com.hmdp.entity.User;  
import com.hmdp.mapper.UserMapper;  
import com.hmdp.service.IUserService;  
import com.hmdp.utils.RegexUtils;  
import lombok.extern.slf4j.Slf4j;  
import org.springframework.stereotype.Service;  
  
import javax.servlet.http.HttpSession;  
  
/**  
 * <p>  
 * æœåŠ¡å®ç°ç±»  
 * </p>  
 *  
 * @author è™å“¥  
 * @since 2021-12-22  
 */@Slf4j  
@Service  
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements IUserService {  
  
    @Override  
    public Result setCode(String phone, HttpSession session) {  
        // 1.æ ¡éªŒæ‰‹æœºå·  
        if (!RegexUtils.isPhoneInvalid(phone)) {  
            // 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯  
            return Result.fail("æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼");  
        }  
        // 3.å¦‚æœç¬¦åˆï¼Œç”Ÿæˆä¸€ä¸ªéªŒè¯ç   
        String code = RandomUtil.randomNumbers(6);  
  
        // 4.ä¿å­˜éªŒè¯ç åˆ°session  
        session.setAttribute("code", code);  
  
        // 5.å‘é€éªŒè¯ç   
        log.debug("å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç :{}", code);  
  
        // 6.è¿”å›ok  
        return Result.ok();  
    }  
}
```


## 2.2 çŸ­ä¿¡éªŒè¯ç ç™»å½•

![CleanShot 2025-10-12 at 15.52.24@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2015.52.24@2x.png)

```java
package com.hmdp.service.impl;  
  
import cn.hutool.core.util.RandomUtil;  
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;  
import com.hmdp.dto.LoginFormDTO;  
import com.hmdp.dto.Result;  
import com.hmdp.entity.User;  
import com.hmdp.mapper.UserMapper;  
import com.hmdp.service.IUserService;  
import com.hmdp.utils.RegexUtils;  
import lombok.extern.slf4j.Slf4j;  
import org.springframework.stereotype.Service;  
  
import javax.servlet.http.HttpSession;  
  
/**  
 * <p>  
 * æœåŠ¡å®ç°ç±»  
 * </p>  
 *  
 * @author è™å“¥  
 * @since 2021-12-22  
 */@Slf4j  
@Service  
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements IUserService {  
  
    @Override  
    public Result setCode(String phone, HttpSession session) {  
        // 1.æ ¡éªŒæ‰‹æœºå·  
        if (!RegexUtils.isPhoneInvalid(phone)) {  
            // 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯  
            return Result.fail("æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼");  
        }  
        // 3.å¦‚æœç¬¦åˆï¼Œç”Ÿæˆä¸€ä¸ªéªŒè¯ç   
        String code = RandomUtil.randomNumbers(6);  
  
        // 4.ä¿å­˜éªŒè¯ç åˆ°session  
        session.setAttribute("code", code);  
  
        // 5.å‘é€éªŒè¯ç   
        log.debug("å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç :{}", code);  
  
        // 6.è¿”å›ok  
        return Result.ok();  
    }  
  
    @Override  
    public Result login(LoginFormDTO loginForm, HttpSession session) {  
        // 1.æ ¡éªŒæ‰‹æœºå·  
        String phone = loginForm.getPhone();  
        if (!RegexUtils.isPhoneInvalid(phone)) {  
            // 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯  
            return Result.fail("æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼");  
        }  
  
        // 2.æ ¡éªŒéªŒè¯ç   
        Object cacheCode = session.getAttribute("code");  
        String code = loginForm.getCode();  
        if (cacheCode == null || !cacheCode.toString().equals(code)) {  
            // 3.å¦‚æœä¸ä¸€è‡´ï¼ŒæŠ¥é”™  
            return Result.fail("éªŒè¯ç é”™è¯¯ï¼");  
        }  
  
        // 4.å¦‚æœä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ· select * from tb_user where phone = ?        User user = query().eq("phone", phone).one();  
  
        // 5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨  
        if (user == null) {  
            // 6.å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å¹¶ä¿å­˜  
            user = createUserWithPhone(phone);  
        }  
  
        // 7.å¦‚æœå­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°session  
        session.setAttribute("user", user);  
  
        // 8.è¿”å›ok  
        return Result.ok();  
    }  
  
    private User createUserWithPhone(String phone) {  
        // 1.åˆ›å»ºç”¨æˆ·  
        User user = new User();  
        user.setPhone(phone);  
        user.setNickName("user_" + RandomUtil.randomString(10));  
        // 2.ä¿å­˜ç”¨æˆ·  
        save(user);  
        // 3.è¿”å›ç”¨æˆ·  
        return user;  
    }  
}
```

## 2.3 ç™»å½•éªŒè¯åŠŸèƒ½

![CleanShot 2025-10-12 at 16.46.45@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2016.46.45@2x.png)


![CleanShot 2025-10-12 at 16.49.33@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2016.49.33@2x.png)

```java
package com.hmdp.utils;  
  
import com.hmdp.dto.UserDTO;  
import org.springframework.web.servlet.HandlerInterceptor;  
  
import javax.servlet.http.HttpServletRequest;  
import javax.servlet.http.HttpServletResponse;  
import javax.servlet.http.HttpSession;  
  
/**  
 * è¿™ä¸ªç±»æ˜¯ï¼š  
 *  
 * @author: CHINHAE  
 * @date: 2025/10/12 16:51  
 * @version: 1.0  
 */public class LoginInterceptor implements HandlerInterceptor{  
    @Override  
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {  
        // 1.è·å–session  
        HttpSession session = request.getSession();  
        // 2.è·å–sessionä¸­çš„ç”¨æˆ·  
        Object user = session.getAttribute("user");  
        // 3.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨  
        if (user == null) {  
            // 4.å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¿”å›false  
            response.setStatus(401);  
            return false;  
        }  
        // 5.å¦‚æœç”¨æˆ·å­˜åœ¨ï¼Œå°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°ThreadLocal  
        UserHolder.saveUser((UserDTO) user);  
        // 6.æ”¾è¡Œ  
        return true;  
    }  
  
    @Override  
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {  
        // 1.ç§»é™¤ThreadLocalä¸­çš„ç”¨æˆ·  
        UserHolder.removeUser();  
    }    
}
```

```java
package com.hmdp.config;  
  
import com.hmdp.utils.LoginInterceptor;  
import org.springframework.context.annotation.Configuration;  
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;  
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;  
  
/**  
 * è¿™ä¸ªç±»æ˜¯ï¼š  
 *  
 * @author: CHINHAE  
 * @date: 2025/10/12 16:58  
 * @version: 1.0  
 */@Configuration  
public class MvcConfig implements WebMvcConfigurer {  
  
    @Override  
    public void addInterceptors(InterceptorRegistry registry) {  
        registry.addInterceptor(new LoginInterceptor())  
            .excludePathPatterns(  
                "/user/code",   
"/user/login",   
"/blog/hot",   
"/shop/**",   
"/shop-type/**",   
"/voucher/**",  
                "/upload/**"  
                );  
    }  
}
```

```java
package com.hmdp.service.impl;  
  
import cn.hutool.core.bean.BeanUtil;  
import cn.hutool.core.util.RandomUtil;  
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;  
import com.hmdp.dto.LoginFormDTO;  
import com.hmdp.dto.Result;  
import com.hmdp.dto.UserDTO;  
import com.hmdp.entity.User;  
import com.hmdp.mapper.UserMapper;  
import com.hmdp.service.IUserService;  
import com.hmdp.utils.RegexUtils;  
import lombok.extern.slf4j.Slf4j;  
import org.springframework.stereotype.Service;  
  
import javax.servlet.http.HttpSession;  
  
/**  
 * <p>  
 * æœåŠ¡å®ç°ç±»  
 * </p>  
 *  
 * @author è™å“¥  
 * @since 2021-12-22  
 */@Slf4j  
@Service  
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements IUserService {  
  
    @Override  
    public Result setCode(String phone, HttpSession session) {  
        // 1.æ ¡éªŒæ‰‹æœºå·  
        if (!RegexUtils.isPhoneInvalid(phone)) {  
            // 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯  
            return Result.fail("æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼");  
        }  
        // 3.å¦‚æœç¬¦åˆï¼Œç”Ÿæˆä¸€ä¸ªéªŒè¯ç   
        String code = RandomUtil.randomNumbers(6);  
  
        // 4.ä¿å­˜éªŒè¯ç åˆ°session  
        session.setAttribute("code", code);  
  
        // 5.å‘é€éªŒè¯ç   
        log.debug("å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç :{}", code);  
  
        // 6.è¿”å›ok  
        return Result.ok();  
    }  
  
    @Override  
    public Result login(LoginFormDTO loginForm, HttpSession session) {  
        // 1.æ ¡éªŒæ‰‹æœºå·  
        String phone = loginForm.getPhone();  
        if (!RegexUtils.isPhoneInvalid(phone)) {  
            // 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯  
            return Result.fail("æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼");  
        }  
  
        // 2.æ ¡éªŒéªŒè¯ç   
        Object cacheCode = session.getAttribute("code");  
        String code = loginForm.getCode();  
        if (cacheCode == null || !cacheCode.toString().equals(code)) {  
            // 3.å¦‚æœä¸ä¸€è‡´ï¼ŒæŠ¥é”™  
            return Result.fail("éªŒè¯ç é”™è¯¯ï¼");  
        }  
  
        // 4.å¦‚æœä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ· select * from tb_user where phone = ?        User user = query().eq("phone", phone).one();  
  
        // 5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨  
        if (user == null) {  
            // 6.å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å¹¶ä¿å­˜  
            user = createUserWithPhone(phone);  
        }  
  
        // 7.å¦‚æœå­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°sessionï¼ˆå°†Userè½¬æ¢ä¸ºUserDTOï¼‰  
        UserDTO userDTO = BeanUtil.copyProperties(user, UserDTO.class);  
        session.setAttribute("user", userDTO);  
  
        // 8.è¿”å›ok  
        return Result.ok();  
    }  
  
    private User createUserWithPhone(String phone) {  
        // 1.åˆ›å»ºç”¨æˆ·  
        User user = new User();  
        user.setPhone(phone);  
        user.setNickName("user_" + RandomUtil.randomString(10));  
        // 2.ä¿å­˜ç”¨æˆ·  
        save(user);  
        // 3.è¿”å›ç”¨æˆ·  
        return user;  
    }  
}
```


# 3.é›†ç¾¤çš„sessionå…±äº«é—®é¢˜

sessionå…±äº«é—®é¢˜ï¼šå¤šå°Tomcatå¹¶ä¸å…±äº«sessionå­˜å‚¨ç©ºé—´ï¼Œå½“è¯·æ±‚åˆ‡æ¢åˆ°ä¸åŒtomcatæœåŠ¡æ—¶å¯¼è‡´æ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚

![CleanShot 2025-10-12 at 17.28.53@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2017.28.53@2x.png)


# 4.åŸºäºRediså®ç°å…±äº«sessionç™»å½•

**ä¿å­˜ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨Stringç»“æ„ï¼Œä»¥JSONå­—ç¬¦ä¸²æ¥ä¿å­˜ï¼Œæ¯”è¾ƒç›´è§‚ï¼š**

![CleanShot 2025-10-12 at 17.39.47@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2017.39.47@2x.png)


**Hashç»“æ„å¯ä»¥å°†å¯¹è±¡ä¸­çš„æ¯ä¸ªå­—æ®µç‹¬ç«‹å­˜å‚¨ï¼Œå¯ä»¥é’ˆå¯¹å•ä¸ªå­—æ®µåšCRUDï¼Œå¹¶ä¸”å†…å­˜å ç”¨æ›´å°‘ï¼š**

![CleanShot 2025-10-12 at 17.39.58@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2017.39.58@2x.png)


![CleanShot 2025-10-12 at 17.43.23@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2017.43.23@2x.png)


![CleanShot 2025-10-12 at 17.45.10@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2017.45.10@2x.png)


**Redisä»£æ›¿sessionéœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼š**
- **é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„**
- **é€‰æ‹©åˆé€‚çš„key**
- **é€‰æ‹©åˆé€‚çš„å­˜å‚¨ç²’åº¦**

```java
package com.hmdp.service.impl;  
  
import cn.hutool.core.bean.BeanUtil;  
import cn.hutool.core.bean.copier.CopyOptions;  
import cn.hutool.core.lang.UUID;  
import cn.hutool.core.util.RandomUtil;  
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;  
import com.hmdp.dto.LoginFormDTO;  
import com.hmdp.dto.Result;  
import com.hmdp.dto.UserDTO;  
import com.hmdp.entity.User;  
import com.hmdp.mapper.UserMapper;  
import com.hmdp.service.IUserService;  
import com.hmdp.utils.RegexUtils;  
import lombok.extern.slf4j.Slf4j;  
import org.springframework.beans.factory.annotation.Autowired;  
import org.springframework.data.redis.core.StringRedisTemplate;  
import org.springframework.stereotype.Service;  
  
import javax.servlet.http.HttpSession;  
import java.util.HashMap;  
import java.util.Map;  
import java.util.concurrent.TimeUnit;  
  
import static com.hmdp.utils.RedisConstants.LOGIN_CODE_KEY;  
import static com.hmdp.utils.RedisConstants.LOGIN_CODE_TTL;  
import static com.hmdp.utils.RedisConstants.LOGIN_USER_KEY;  
import static com.hmdp.utils.RedisConstants.LOGIN_USER_TTL;  
  
/**  
 * <p>  
 * æœåŠ¡å®ç°ç±»  
 * </p>  
 *  
 * @author è™å“¥  
 * @since 2021-12-22  
 */@Slf4j  
@Service  
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements IUserService {  
  
    @Autowired  
    private StringRedisTemplate stringRedisTemplate;  
  
    @Override  
    public Result setCode(String phone, HttpSession session) {  
        // 1.æ ¡éªŒæ‰‹æœºå·  
        if (!RegexUtils.isPhoneInvalid(phone)) {  
            // 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯  
            return Result.fail("æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼");  
        }  
        // 3.å¦‚æœç¬¦åˆï¼Œç”Ÿæˆä¸€ä¸ªéªŒè¯ç   
        String code = RandomUtil.randomNumbers(6);  
  
        // 4.ä¿å­˜éªŒè¯ç åˆ°redis // set key value ex 120 å•ä½ç§’  
        stringRedisTemplate.opsForValue().set(LOGIN_CODE_KEY + phone, code, LOGIN_CODE_TTL, TimeUnit.MINUTES);  
  
        // 5.å‘é€éªŒè¯ç   
        log.debug("å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç :{}", code);  
  
        // 6.è¿”å›ok  
        return Result.ok();  
    }  
  
    @Override  
    public Result login(LoginFormDTO loginForm, HttpSession session) {  
        // 1.æ ¡éªŒæ‰‹æœºå·  
        String phone = loginForm.getPhone();  
        if (!RegexUtils.isPhoneInvalid(phone)) {  
            // 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯  
            return Result.fail("æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼");  
        }  
  
        // 2.ä»redisä¸­è·å–éªŒè¯ç   
        String cacheCode = stringRedisTemplate.opsForValue().get(LOGIN_CODE_KEY + phone);  
        String code = loginForm.getCode();  
        // 3.æ¯”è¾ƒéªŒè¯ç   
        if (cacheCode == null || !cacheCode.equals(code)) {  
            // 3.å¦‚æœä¸ä¸€è‡´ï¼ŒæŠ¥é”™  
            return Result.fail("éªŒè¯ç é”™è¯¯ï¼");  
        }  
  
        // 4.å¦‚æœä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ· select * from tb_user where phone = ?        User user = query().eq("phone", phone).one();  
  
        // 5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨  
        if (user == null) {  
            // 6.å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å¹¶ä¿å­˜  
            user = createUserWithPhone(phone);  
        }  
  
        // 6.éšæœºç”Ÿæˆtokenï¼Œä½œä¸ºç™»å½•ä»¤ç‰Œ  
        String token = UUID.randomUUID().toString(true);  
  
        // 7.å°†Userå¯¹è±¡æ¢ä¸ºHashå­˜å‚¨  
        UserDTO userDTO = BeanUtil.copyProperties(user, UserDTO.class);  
        Map<String, Object> userMap = BeanUtil.beanToMap(userDTO,new HashMap<>(),  
            CopyOptions.create()  
            .setIgnoreNullValue(true)  
            .setFieldValueEditor((fieldName, fieldValue) -> fieldValue.toString()));  
  
        // 8.å­˜å‚¨tokenåˆ°redis  
        String tokenKey = LOGIN_USER_KEY + token;  
        stringRedisTemplate.opsForHash().putAll(tokenKey, userMap);  
        // 9.è®¾ç½®tokençš„è¿‡æœŸæ—¶é—´  
        stringRedisTemplate.expire(tokenKey, LOGIN_USER_TTL, TimeUnit.MINUTES);  
  
        // 9.è¿”å›ok  
        return Result.ok(token);  
    }  
  
    private User createUserWithPhone(String phone) {  
        // 1.åˆ›å»ºç”¨æˆ·  
        User user = new User();  
        user.setPhone(phone);  
        user.setNickName("user_" + RandomUtil.randomString(10));  
        // 2.ä¿å­˜ç”¨æˆ·  
        save(user);  
        // 3.è¿”å›ç”¨æˆ·  
        return user;  
    }  
}
```

# 5.ç™»å½•æ‹¦æˆªå™¨çš„ä¼˜åŒ–

ä¹‹å‰çš„æ‹¦æˆªå™¨æµç¨‹ï¼š

![CleanShot 2025-10-12 at 18.45.30@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2018.45.30@2x.png)


ä¼˜åŒ–çš„æµç¨‹ï¼š

![CleanShot 2025-10-12 at 18.47.12@2x.png](https://picgo-q1uill.oss-cn-chengdu.aliyuncs.com/img-for-typora/CleanShot%202025-10-12%20at%2018.47.12@2x.png)


```java
package com.hmdp.config;  
  
import com.hmdp.utils.LoginInterceptor;  
import com.hmdp.utils.RefreshTokenInterceptor;  
import org.springframework.context.annotation.Configuration;  
import org.springframework.data.redis.core.StringRedisTemplate;  
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;  
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;  
  
import javax.annotation.Resource;  
  
/**  
 * è¿™ä¸ªç±»æ˜¯ï¼š  
 *  
 * @author: CHINHAE  
 * @date: 2025/10/12 16:58  
 * @version: 1.0  
 */@Configuration  
public class MvcConfig implements WebMvcConfigurer {  
  
    @Resource  
    private StringRedisTemplate stringRedisTemplate;  
  
    @Override  
    public void addInterceptors(InterceptorRegistry registry) {  
        // ç™»å½•æ‹¦æˆªå™¨  
        registry.addInterceptor(new LoginInterceptor())  
            .excludePathPatterns(  
                "/user/code",   
"/user/login",   
"/blog/hot",   
"/shop/**",   
"/shop-type/**",   
"/voucher/**",  
                "/upload/**"  
                ).order(1);  
  
        // åˆ·æ–°tokenæ‹¦æˆªå™¨  
        registry.addInterceptor(new RefreshTokenInterceptor(stringRedisTemplate))  
            .addPathPatterns("/**").order(0);  
    }  
}
```

```java
package com.hmdp.utils;  
  
import org.springframework.web.servlet.HandlerInterceptor;  
  
import javax.servlet.http.HttpServletRequest;  
import javax.servlet.http.HttpServletResponse;  
  
/**  
 * è¿™ä¸ªç±»æ˜¯ï¼š  
 *  
 * @author: CHINHAE  
 * @date: 2025/10/12 16:51  
 * @version: 1.0  
 */public class LoginInterceptor implements HandlerInterceptor{  
  
    @Override  
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {  
        // 1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªï¼ˆThreadLocalä¸­æ˜¯å¦æœ‰ç”¨æˆ·ï¼‰  
        if (UserHolder.getUser() == null) {  
            // 2.æ²¡æœ‰ï¼Œéœ€è¦æ‹¦æˆªï¼Œè®¾ç½®çŠ¶æ€ç   
            response.setStatus(401);  
            return false;  
        }  
        // 3.æœ‰ï¼Œåˆ™æ”¾è¡Œ  
        return true;  
    }  
}
```

```java
package com.hmdp.utils;  
  
import cn.hutool.core.bean.BeanUtil;  
import cn.hutool.core.util.StrUtil;  
import com.hmdp.dto.UserDTO;  
import org.springframework.data.redis.core.StringRedisTemplate;  
import org.springframework.web.servlet.HandlerInterceptor;  
  
import javax.servlet.http.HttpServletRequest;  
import javax.servlet.http.HttpServletResponse;  
import java.util.Map;  
import java.util.concurrent.TimeUnit;  
  
/**  
 * è¿™ä¸ªç±»æ˜¯ï¼š  
 *  
 * @author: CHINHAE  
 * @date: 2025/10/12 16:51  
 * @version: 1.0  
 */public class RefreshTokenInterceptor implements HandlerInterceptor{  
  
    private StringRedisTemplate stringRedisTemplate;  
  
    public RefreshTokenInterceptor(StringRedisTemplate stringRedisTemplate) {  
        this.stringRedisTemplate = stringRedisTemplate;  
    }  
  
    @Override  
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {  
        // 1.è·å–è¯·æ±‚å¤´ä¸­çš„token  
        String token = request.getHeader("authorization");  
        if (StrUtil.isBlank(token)) {  
            return true;  
        }  
        // 2.åŸºäºtokenè·å–redisä¸­çš„ç”¨æˆ·  
        String key = RedisConstants.LOGIN_USER_KEY + token;  
        Map<Object, Object> userMap = stringRedisTemplate.opsForHash()  
            .entries(key);  
        // 3.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨  
        if (userMap.isEmpty()) {  
            return true;  
        }  
        // 5.å°†æŸ¥è¯¢åˆ°çš„Hashæ•°æ®è½¬æ¢ä¸ºUserDTOå¯¹è±¡  
        UserDTO userDTO = BeanUtil.fillBeanWithMap(userMap, new UserDTO(), false);  
  
        // 6.å­˜åœ¨ï¼Œåˆ™å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°ThreadLocal  
        UserHolder.saveUser(userDTO);  
  
        // 7.åˆ·æ–°tokençš„æœ‰æ•ˆæœŸ  
        stringRedisTemplate.expire(key, RedisConstants.LOGIN_USER_TTL, TimeUnit.MINUTES);  
  
        // 8.æ”¾è¡Œ  
        return true;  
    }  
  
    @Override  
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {  
        // 1.ç§»é™¤ThreadLocalä¸­çš„ç”¨æˆ·  
        UserHolder.removeUser();  
    }  
  
  
}
```